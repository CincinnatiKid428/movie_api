<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: index.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: index.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>//File: index.js - API route handlers for the myFlix application

const express = require('express');
const app = express();

const { check, validationResult } = require('express-validator');
const validator = require('validator'); //used for date validation
const { checkValidationResults } = require('./util.js');

const fs = require('fs');
const path = require('path');
const morgan = require('morgan');

const bodyParser = require('body-parser');

const mongoose = require('mongoose');
const Models = require('./models.js');
const Movies = Models.Movie;
const Users = Models.User;

// Connection to MongoDB if using local database
//mongoose.connect('mongodb://localhost:27017/myFlix', {});

// Connection to MongoDB if using Atlas database
mongoose.connect(process.env.DB_CONNECTION_URI);

// Express middleware:
app.use(express.urlencoded({ extended: true }));
app.use(express.static('public')); // to use public folder for serving static html files

// Logging stream to log.txt with append flag set
const accessLogStream = fs.createWriteStream(path.join(__dirname, 'log.txt'), { flags: 'a' });
app.use(morgan('common', { stream: accessLogStream }));
const DEBUG_LOG = false; //controls logging

app.use(bodyParser.json()); // parse request bodies into JSON format

// Use CORS before routing to allow all domains access to API
const cors = require('cors');
app.use(cors());

let auth = require('./auth.js')(app);
const passport = require('passport');
require('./passport.js');

// Requests &amp; handling -----------------------------------------------------

app.get('/', (req, res) => {
    res.status(200).send('This will be the homepage for my API!');
});


/**
 * Returns static HTML API documentation page.
 * @returns Returns file `public/documentation.html` to the user.
 * @example Route: GET /documentation
 */
function getApiHtmlDoc(req, res) {
    DEBUG_LOG &amp;&amp; console.log('Sending file for /documentation request path: ' + path.join(__dirname, 'public', 'documentation.html'));
    res.sendFile(path.join(__dirname, 'public', 'documentation.html'));
}

app.get('/documentation', getApiHtmlDoc);


/**
 * Sends HTTP GET request to retrieve data on all movies.
 * @function getAllMovies
 * @param {Object} req - Express request object
 * @param {Object} res - Express response object
 * @returns {void} `return` sends response
 * @example Route: GET /movies
 * @example Response Object (partial):
 * ```json
 *  [
 *      {
 *          "Genre": {
 *              "Name": "Drama",
 *              "Description": "The drama genre is a broad category that features stories portraying human experiences..."
 *          },
 *          "Director": {
 *              "Name": "Frank Darabont",
 *              "Bio": "Three-time Oscar nominee Frank Darabont was born in a refugee camp in 1959 in Montbeliard, France...",
 *              "BirthYear": "1959",
 *              "DeathYear": null,
 *                  "The Shawshank Redemption",
 *                  "The Green Mile",
 *                  "The Majestic"
 *              ]
 *          },
 *          "_id": "671ea93b577ed8cab386b01e",
 *          "Title": "The Shawshank Redemption",
 *          "ReleaseYear": "1994",
 *          "Rating": "9.3",
 *          "Description": "A banker convicted of uxoricide forms a friendship over a quarter century with a hardened convict, while maintaining his innocence and trying to remain hopeful through simple compassion.",
 *          "Actors": [
 *              "Tim Robbins",
 *              "Morgan Freeman",
 *              "Bob Gunton"
 *          ],
 *          "ImageURL": "https://m.media-amazon.com/images/M/MV5BMDAyY2FhYjctNDc5OS00MDNlLThiMGUtY2UxYWVkNGY2ZjljXkEyXkFqcGc@._V1_SX300.jpg",
 *          "Featured": true
 *      },
 *      ..., //more documents
 *  ]
 * ```
 */
async function getAllMovies(req, res) {

    try {
        DEBUG_LOG &amp;&amp; console.log("GET: Request for list of all movies...");

        const responseMovies = await Movies.find();
        if (!responseMovies) {
            return res.status(404).send('GET failed - Could not retrieve movies: ' + responseMovies);
        } else {
            return res.status(200).json(responseMovies);
        }
    } catch (err) {
        console.error(err);
        return res.status(500).send('GET failed - Server error retreiving movie list: ' + err);
    }
}
app.get('/movies', passport.authenticate('jwt', { session: false }), getAllMovies);


/**
 * Sends HTTP GET request for information about one movie by Title.
 * @function getMovieByTitle
 * @param {Object} req - Express request object
 * @param {Object} res - Express response object
 * @returns {void} `return` sends response
 * @example Route: GET /movies/:Title
 * @example Response Object (Title: 'Fight Club'):
 * ```json
 *   {
 *       "Title": "Fight Club",
 *       "ReleaseYear": "1999",
 *       "Rating": "8.8",
 *       "Description": "An insomniac office worker and a devil-may-care soap maker form an underground fight club that evolves into much more.",
 *       "Director": "David Fincher",
 *       "Genre": "Drama",
 *       "Actors": [
 *           "Brad Pitt",
 *           "Edward Norton",
 *           "Helena Bonham Carter",
 *           "Meat Loaf"
 *       ],
 *       "ImageURL": "https://m.media-amazon.com/images/M/MV5BOTgyOGQ1NDItNGU3Ny00MjU3LTg2YWEtNmEyYjBiMjI1Y2M5XkEyXkFqcGc@._V1_SX300.jpg",
 *       "Featured": true
 *   }
 * ```
 */
async function getMovieByTitle(req, res) {

    //Check validation on movie title
    if (!checkValidationResults(validationResult(req), res)) {
        return; //Response sent back to client by checkValidationResults
    }

    try {
        DEBUG_LOG &amp;&amp; console.log('GET : Searching for info on movie: ' + req.params.Title);

        const movieFound = await Movies.findOne({ Title: req.params.Title });
        let returnMovie = {
            Title: movieFound?.Title ?? '',
            ReleaseYear: movieFound?.ReleaseYear ?? '',
            Rating: movieFound?.Rating ?? '',
            Description: movieFound?.Description ?? '',
            Director: movieFound?.Director.Name ?? '',
            Genre: movieFound?.Genre.Name ?? '',
            Actors: movieFound?.Actors ?? [],
            ImageURL: movieFound?.ImageURL ?? '',
            Featured: movieFound?.Featured ?? ''
        };

        DEBUG_LOG &amp;&amp; console.log("GET: The returnMovie value is:", returnMovie);
        return res.status(200).json(returnMovie);

    } catch (err) {
        console.error(err);
        return res.status(500).send("GET failed - Error looking for movie details about :" + req.params.Title + " with error : " + err);
    }
}

app.get('/movies/:Title', passport.authenticate('jwt', { session: false }),
    [
        check('Title', 'Invalid movie title - may only contain alphanumeric characters, spaces, hyphens, colons, and ampersands').matches(/^[a-zA-Z0-9\s\-\:\&amp;]+$/)
    ], getMovieByTitle);


/**
 * Sends HTTP GET request for information about a genre by Name.
 * @function getGenreByName
 * @param {Object} req - Express request object
 * @param {Object} res - Express response object
 * @returns {void} `return` sends response
 * @example Route: GET /genre/:Name
 * @example Response Object (Name: 'Drama'):
 * ```json
 *   {
 *    "Name" : "Drama",
 *    "Description" : "The drama genre is characterized by..."
 *   }
 * ```
 */
async function getGenreByName(req, res) {

    //Check validation on director name
    if (!checkValidationResults(validationResult(req), res)) {
        return; //Response sent back to client by checkValidationResults
    }

    try {
        DEBUG_LOG &amp;&amp; console.log('GET: Looking for information about the movie genre ' + req.params.Name);

        const genreFoundInMovie = await Movies.findOne({ "Genre.Name": req.params.Name });
        return res.status(200).json(genreFoundInMovie.Genre);

    } catch (err) {
        console.error(err);
        return res.status(500).send("GET failed : Could not get info about genre " + req.params.Name + " with error : " + err);
    }
}
app.get('/genre/:Name', passport.authenticate('jwt', { session: false }),
    [
        check('Name', 'Invalid genre name, may only contain alpha characters, spaces and hyphens').matches(/^[a-zA-Z0-9\s\-]+$/)
    ], getGenreByName);


/**
 * Sends HTTP GET request for information about a director by Name.
 * @function getDirectorByName
 * @param {Object} req - Express request object
 * @param {Object} res - Express response object
 * @returns {void} `return` sends response
 * @example Route: GET /director/:Name
 * @example Response Object (Name: 'Rob Reiner'):
 * ```json
 *  {
 *    "Name" : "Rob Reiner",
 *    "Bio" : "A short biography about Rob Reiner..."
 *    "BirthYear" : "1947",
 *    "DeathYear" : "",
 *    "Movies" : ["Stand by Me", "When Harry Met Sally", "Misery", "A Few Good Men"]
 *  }
 * ```
 */
async function getDirectorByName(req, res) {

    //Check validation on director name
    if (!checkValidationResults(validationResult(req), res)) {
        return; //Response sent back to client by checkValidationResults
    }

    try {
        DEBUG_LOG &amp;&amp; console.log('GET: Looking for information about director ' + req.params.Name);

        const directorFoundInMovie = await Movies.findOne({ "Director.Name": req.params.Name });
        return res.status(200).json(directorFoundInMovie.Director);

    } catch (err) {
        console.error(err);
        return res.status(500).send("GET failed : Could not get info about director " + req.params.Name + " with error : " + err);
    }
}
app.get('/director/:Name', passport.authenticate('jwt', { session: false }),
    [
        check('Name', 'Invalid director name, must be alpha characters, hyphen or apostrophe').matches(/^[a-zA-Z\s\-\']+$/)
    ], getDirectorByName);


/**
 * Sends HTTP POST request to register a new user.
 * @function registerNewUser
 * @param {Object} req - Express request object
 * @param {Object} res - Express response object
 * @returns {void} `return` sends response
 * @example Route: POST /users/
 * @example Request Object:
 * ```json
 *  {
 *      Username: String,
 *      Password: String,  //will be hashed prior to storing
 *      Email: String,
 *      Birthdate: Date
 *  }
 * ```
 * @example Response Object (newly created user):
 * ```json
 *   {
 *       "Username": "Test123",
 *       "Password": "$2b$10$EUN1sp/Qg0XQnwvTZwwM8.fl8GZVRFmuwJ8x6V3VJraFeZsGwKMLG",
 *       "Email": "Email123@email.com",
 *       "Birthdate": "2001-01-19T00:00:00.000Z",
 *       "FavoriteMovies": [],
 *       "_id": "68caf703442939d1fb7a013a",
 *       "__v": 0
 *   }
 * ```
 */
async function registerNewUser(req, res) {

    //Check for validation errors before registering new user
    if (!checkValidationResults(validationResult(req), res)) {
        return; //Response sent back to client by checkValidationResults
    }

    //Birthdate validation for proper date format, validator.isDate() defaults to yyyy/mm/dd
    let dateValue = req.body.Birthdate;
    if (!validator.isDate(dateValue)) {
        dateValue = '';
    }

    try {
        DEBUG_LOG &amp;&amp; console.log('POST: Trying to register a user: ');
        DEBUG_LOG &amp;&amp; console.log(JSON.stringify(req.body));

        const user = await Users.findOne({ Username: req.body.Username });

        if (user) {
            res.status(400).send(req.body.Username + ' already exists, please try another Username');
        } else {
            let hashedPassword = Users.hashPassword(req.body.Password); // fn() hashPassword defined in models.js

            //Create the new account
            const newUser = await Users.create({
                Username: req.body.Username,
                Password: hashedPassword,
                Email: req.body.Email,
                Birthdate: dateValue
            });

            DEBUG_LOG &amp;&amp; console.log("POST: Created new user: ", newUser);
            res.status(201).json(newUser);
        }

    } catch (err) {
        console.error(err);
        res.status(500).send('POST failed - Unable to register new user ' + req.body.Username + ': ' + err);
    }
}

app.post('/users',
    [
        //Validate user inputted fields from request body
        check('Username', 'Username cannot be empty').not().isEmpty(),
        check('Username', 'Username must be at least 5 characters').isLength({ min: 5 }),
        check('Username', 'Username contains non-alphanumeric characters -- not permitted').isAlphanumeric(),
        check('Password', 'Password cannot be empty').not().isEmpty(),
        check('Email', 'Email address is invalid').isEmail()
        //Birthdate validation performed below as it is not a required field
    ], registerNewUser);


/**
 * Sends HTTP PUT request to update user's account info (Password, Email &amp; Birthdate).
 * @function updateUserInfo
 * @param {Object} req - Express request object
 * @param {Object} res - Express response object
 * @returns {void} `return` sends response
 * @example Route: PUT /users/:Username
 * @example Request Object:
 * ```json
 *  {
 *      Password: String,   (required)
 *      Email: String,      (required)
 *      Birthdate: Date
 *  }
 * ```
 * @example Response Object:
 * ```json
 *   {
 *       "_id": "68caf703442939d1fb7a013a",
 *       "Username": "Test123",
 *       "Password": "$2b$10$A3tJTXdYyD0V6qPN7.vl0eW/8QW0jcnwrKGRXGhFULjSaL9BIfoO6",
 *       "Email": "myNewEmail@email.com",
 *       "Birthdate": "1999-10-31T00:00:00.000Z",
 *       "FavoriteMovies": [],
 *       "__v": 0
 *   }
 * ```
 */
async function updateUserInfo(req, res) {

    //Check for validation errors before updating account info
    if (!checkValidationResults(validationResult(req), res)) {
        return; //Response sent back to client by checkValidationResults
    }

    //Check to see if Username to update matches the info in token:
    if (req.params.Username !== req.user.Username) {
        return res.status(401).send('Permission denied');
    }

    //Birthdate validation for proper date format, validator.isDate() defaults to yyyy/mm/dd
    let dateValue = req.body.Birthdate;
    if (!validator.isDate(dateValue)) {
        dateValue = '';
    }

    //If all checks passed, then update account info
    DEBUG_LOG &amp;&amp; console.log("PUT: Trying to update account information for " + req.user.Username + ": " + JSON.stringify(req.body));

    let hashedPassword = Users.hashPassword(req.body.Password); // fn() hashPassword defined in models.js

    try {
        const updatedUser = await Users.findOneAndUpdate({ Username: req.user.Username },
            {
                $set: {
                    Password: hashedPassword,
                    Email: req.body.Email,
                    Birthdate: dateValue
                }
            },
            { new: true } //Send updated account info JSON back as response
        );
        res.status(200).json(updatedUser);

    } catch (err) {
        console.error(err);
        res.status(500).send('PUT failed - Error updating account informaion: ' + err);
    }
}

app.put('/users/:Username', passport.authenticate('jwt', { session: false }),
    [
        //Validate Password, Email input here
        check('Password', 'Password cannot be empty').not().isEmpty(),
        check('Email', 'Email address is invalid').isEmail()
        //Date validation for Birthdate done below

    ], updateUserInfo);


/**
 * Sends HTTP POST request to add MovieID to user's favorite movies list.
 * @function addFavMovie
 * @param {Object} req - Express request object
 * @param {Object} res - Express response object
 * @returns {void} `return` sends response
 * @example Route: POST /movies/favorites/:MovieID
 * @example Response Object (add MovieID: "671ec4d7577ed8cab386b025"):
 * ```json
 *   {
 *       "_id": "68caf703442939d1fb7a013a",
 *       "Username": "Test123",
 *       "Password": "$2b$10$x4YPLb82YlGtHr1/O.BcV.06IfvhRBcM5Dur5In6Ivuq3K8qmyery",
 *       "Email": "myNewEmail@email.com",
 *       "Birthdate": "1999-10-31T00:00:00.000Z",
 *       "FavoriteMovies": [
 *           "671eb9b9577ed8cab386b021",
 *           "671ec4d7577ed8cab386b023",
 *           "671ebe39577ed8cab386b022",
 *           "671ec4d7577ed8cab386b025"
 *       ],
 *       "__v": 0
 *   }
 * ```
 */
async function addFavMovie(req, res) {

    //Check for input validation errors with MovieID prior to attempting to add the movie to favorites list
    if (!checkValidationResults(validationResult(req), res)) {
        return; //Response sent back to client by checkValidationResults
    }

    DEBUG_LOG &amp;&amp; console.log('POST: Verifying MovieID ' + req.params.MovieID + ' is in the database');

    // Verify MovieID is in the database
    try {
        const movie = await Movies.findOne({ _id: req.params.MovieID });
        if (!movie) {
            return res.status(400).send('POST failed: Unable to find movieID: ' + req.params.movieID);
        }
    } catch (err) {
        console.error('POST failed: Error checking database for movieID ' + req.params.movieID + ': ' + err);
        return res.status(500).send('POST failed: Error checking database for movieID ' + req.params.movieID + ': ' + err);
    }

    DEBUG_LOG &amp;&amp; console.log('POST: Trying to add movie ' + req.params.MovieID + ' to favorites list for account: ' + req.user.Username);

    try {
        const updatedUser = await Users.findOneAndUpdate(
            { Username: req.user.Username },
            { $addToSet: { FavoriteMovies: req.params.MovieID } }, //$addToSet: handles if movie is already in list prior to add
            { new: true } //return the new document after update
        );
        res.status(200).json(updatedUser);

    } catch (err) {
        console.error(err);
        res.status(500).send("POST failed: Could not add MovieID " + req.params.MovieID + " to favorites list: " + err);
    }
}

app.post('/movies/favorites/:MovieID', passport.authenticate('jwt', { session: false }),
    [
        //Validation for MovieID as alphanumeric
        check('MovieID', 'Invalid movie ID - must be alphanumeric').isAlphanumeric()
    ], addFavMovie);


/**
 * Sends HTTP DELETE request to remove MovieID from the user's favorite list.
 * @function deleteFavMovie
 * @param {Object} req - Express request object
 * @param {Object} res - Express response object
 * @returns {void} `return` sends response
 * @example Route: DELETE /movies/favorites/:MovieID
 * @example Response Object (remove MovieID: "671ec4d7577ed8cab386b023"):
 * ```json
 *   {
 *       "_id": "68caf703442939d1fb7a013a",
 *       "Username": "Test123",
 *       "Password": "$2b$10$x4YPLb82YlGtHr1/O.BcV.06IfvhRBcM5Dur5In6Ivuq3K8qmyery",
 *       "Email": "myNewEmail@email.com",
 *       "Birthdate": "1999-10-31T00:00:00.000Z",
 *       "FavoriteMovies": [
 *           "671eb9b9577ed8cab386b021",
 *           "671ebe39577ed8cab386b022",
 *           "671ec4d7577ed8cab386b025"
 *       ],
 *       "__v": 0
 *   }
 * ```
 */
async function deleteFavMovie(req, res) {

    //Check for input validation errors with MovieID prior to attempting to delete it
    if (!checkValidationResults(validationResult(req), res)) {
        return; //Response sent back to client by checkValidationResults
    }

    // No need to verify if MovieID is in the database, only need to check favorite list elements

    DEBUG_LOG &amp;&amp; console.log('DELETE: Trying to delete movie ' + req.params.MovieID + ' from favorites list for account ' + req.user.Username);

    try {
        const updatedUser = await Users.findOneAndUpdate(
            { Username: req.user.Username },
            { $pull: { FavoriteMovies: req.params.MovieID } }, //$pull: handles if item is not in the array
            { new: true }
        );
        res.status(200).json(updatedUser);

    } catch (err) {
        console.error(err);
        res.status(500).send("DELETE failed - Could not remove MovieID " + req.params.MovieID + " from favorites list: " + err);
    }
}

app.delete('/movies/favorites/:MovieID', passport.authenticate('jwt', { session: false }),
    [
        //Validation for MovieID as alphanumeric
        check('MovieID', 'Invalid movie ID - must be alphanumeric').isAlphanumeric()
    ], deleteFavMovie);


/**
 * Sends HTTP DELETE request to deregister the user account.
 * @function deleteUser
 * @param {Object} req - Express request object
 * @param {Object} res - Express response object
 * @returns {void} `return` sends response 
 * @example Route: DELETE /users
 * @example Responses:
 *  - Success: "DELETE successful : Account Test123 has been removed."
 *  - Failure: "DELETE failed - Could not remove account Test123 due to server error: &lt;error>"
 *  - Not Found: "DELETE failed - User Test123 could not be found."
 */
async function deleteUser(req, res) {

    DEBUG_LOG &amp;&amp; console.log("Trying to deregister user account : " + req.user.Username);

    try {
        const deletedUser = await Users.findOneAndDelete({ Username: req.user.Username, Password: req.user.Password });

        if (!deletedUser) {
            res.status(400).send("DELETE failed - User " + req.user.Username + " could not be found.");
        } else {
            res.status(200).send("DELETE successful : Account " + req.user.Username + " has been removed.")
        }

    } catch (err) {
        console.error(err);
        res.status(500).send("DELETE failed - Could not remove account " + req.user.Username + " due to server error: " + err);
    }
}

app.delete('/users', passport.authenticate('jwt', { session: false }), deleteUser);


/**
 * Logs errors and sends response back to frontend.
 */
app.use((err, req, res, next) => {
    console.error(err.stack);
    res.status(500).send('The application encountered an error, please try again.');
});


const port = process.env.PORT || 8080;
app.listen(port, '0.0.0.0', () => {
    console.log('\n[][][] myFlix(Matinee) Movie API server is up and listening on port ' + port + '... [][][]\n');
});</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Global</h3><ul><li><a href="global.html#addFavMovie">addFavMovie</a></li><li><a href="global.html#checkValidationResults">checkValidationResults</a></li><li><a href="global.html#deleteFavMovie">deleteFavMovie</a></li><li><a href="global.html#deleteUser">deleteUser</a></li><li><a href="global.html#getAllMovies">getAllMovies</a></li><li><a href="global.html#getApiHtmlDoc">getApiHtmlDoc</a></li><li><a href="global.html#getDirectorByName">getDirectorByName</a></li><li><a href="global.html#getGenreByName">getGenreByName</a></li><li><a href="global.html#getMovieByTitle">getMovieByTitle</a></li><li><a href="global.html#loginUser">loginUser</a></li><li><a href="global.html#registerNewUser">registerNewUser</a></li><li><a href="global.html#updateUserInfo">updateUserInfo</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.4</a> on Sun Sep 21 2025 19:59:07 GMT-0400 (Eastern Daylight Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
